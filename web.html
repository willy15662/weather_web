<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather API</title>
</head>
<body>
    <h1>Enter Latitude and Longitude</h1>
    <form>
        <label for="lat">Latitude:</label>
        <input type="text" id="lat" name="lat"><br><br>
        <label for="lon">Longitude:</label>
        <input type="text" id="lon" name="lon"><br><br>
        <input type="submit" value="Submit">
    </form>
    <button id="downloadBtn">Download Chart</button>
</body>
</html>

<canvas id="weatherChart" width="200" height="100"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.querySelector('form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;

        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
        const data = await response.json();

        let table = '<h2>Weather Data</h2><table border="1"><tr><th>Date</th><th>Weather Code</th><th>Max Temperature (2m)</th><th>Min Temperature (2m)</th></tr>';

        const daily = data.daily;

        for (let i = 0; i < daily.time.length; i++) {
            table += `<tr>
                <td>${daily.time[i]}</td>
                <td>
                    <button onclick="adjustWeather(${i}, -1)">-</button>
                    <span id="weather-${i}">${daily.weather_code[i]}</span>
                    <button onclick="adjustWeather(${i}, 1)">+</button>
                </td>
                <td>
                    <button onclick="adjustTemp('max', ${i}, -0.1)">-</button>
                    <span id="max-temp-${i}">${daily.temperature_2m_max[i]}</span>
                    <button onclick="adjustTemp('max', ${i}, 0.1)">+</button>
                </td>
                <td>
                    <button onclick="adjustTemp('min', ${i}, -0.1)">-</button>
                    <span id="min-temp-${i}">${daily.temperature_2m_min[i]}</span>
                    <button onclick="adjustTemp('min', ${i}, 0.1)">+</button>
                </td>
            </tr>`;
        }
        table += '</table><br><br><br><br><br><br>';
        document.body.innerHTML += table;

        const ctx = document.getElementById('weatherChart').getContext('2d');
        const weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: daily.time,
                datasets: [
                    {
                        label: 'Max Temperature (2m)',
                        data: daily.temperature_2m_max,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Min Temperature (2m)',
                        data: daily.temperature_2m_min,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        fill: false
                    }
                ]
            },
            options: {
                scales: {
                    y: {
                        min: Math.min(...daily.temperature_2m_min) - 5, // 自動調整最小值
                        max: Math.max(...daily.temperature_2m_max) + 5  // 自動調整最大值
                    }
                }
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', function() {
            const link = document.createElement('a');
            link.href = weatherChart.toBase64Image();
            link.download = 'weather_chart.png';
            link.click();
        });

        window.adjustTemp = function(type, index, adjustment) {
            const tempSpan = document.getElementById(`${type}-temp-${index}`);
            let currentTemp = parseFloat(tempSpan.textContent);
            currentTemp += adjustment;
            tempSpan.textContent = currentTemp.toFixed(1);

            if (type === 'max') {
                weatherChart.data.datasets[0].data[index] = currentTemp;
            } else {
                weatherChart.data.datasets[1].data[index] = currentTemp;
            }
            weatherChart.update();
        };

        window.adjustWeather = function(index, adjustment) {
            const weatherSpan = document.getElementById(`weather-${index}`);
            let currentWeather = parseInt(weatherSpan.textContent);
            currentWeather += adjustment;
            weatherSpan.textContent = currentWeather;
        };
    });
</script>